name: Project - Azure DevOps Mate

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - 'Directory.Build.props'
      - 'Directory.Packages.props'
      - 'global.json'
      - 'shared/CabaVS.Shared.Infrastructure/**'
      - '.github/workflows/proj-azuredevopsmate.yml'
      - 'proj.azuredevopsmate.Dockerfile'
      - 'proj-azuredevopsmate/**'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  BUILD_CONFIGURATION: "Release"
  DOCKER_IMAGE_NAME: "proj-azuredevopsmate"
  DOCKER_IMAGE_NAME_JOB_RWT: "proj-azuredevopsmate-jobs-rwt"
  DOCKERFILE_PATH: "./proj.azuredevopsmate.Dockerfile"
  DOCKERFILE_PATH_JOB_RWT: "./proj.azuredevopsmatejobrwt.Dockerfile"
  PATH_TO_CSPROJ: "./proj-azuredevopsmate/CabaVS.AzureDevOpsMate/CabaVS.AzureDevOpsMate.csproj"
  PATH_TO_CSPROJ_JOBS_RWT: "./proj-azuredevopsmate/CabaVS.AzureDevOpsMate.Jobs.RemainingWorkTracker/CabaVS.AzureDevOpsMate.Jobs.RemainingWorkTracker.csproj"
  PATH_TO_GLOBAL_JSON: "./global.json"

jobs:
  build-app:
    name: Build application
    runs-on: ubuntu-latest
    
    outputs:
      content_tag: ${{ steps.tagcalc.outputs.content_tag }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ${{ env.PATH_TO_GLOBAL_JSON }}

      - name: Restore
        run: dotnet restore ${{ env.PATH_TO_CSPROJ }}

      - name: Build
        run: dotnet build ${{ env.PATH_TO_CSPROJ }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
        
      - name: Publish
        run: |
          dotnet publish \
            --no-build \
            -c ${{ env.BUILD_CONFIGURATION }} \
            -o ./publish \
            -p:ContinuousIntegrationBuild=true \
            -p:Deterministic=true \
            ${{ env.PATH_TO_CSPROJ }}
      
      - name: Compute publish-output tag
        id: tagcalc
        run: |
          set -euo pipefail
          CONTENT_HASH=$(
            cd ./publish
            find . -type f ! -name '*.pdb' -print0 \
              | sort -z \
              | xargs -0 sha256sum \
              | sha256sum \
              | awk '{print $1}'
          )
          echo "content_tag=${CONTENT_HASH:0:12}" >> "$GITHUB_OUTPUT"      
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-publish
          path: ./publish
  
  push-image:
    environment: production
    name: Push image to ACR
    needs: [build-app]
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: ./publish

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}
        
      - name: Check if content tag exists in ACR
        id: exist
        run: |
          set -euo pipefail
          EXISTS=$(az acr repository show-tags \
            -n ${{ secrets.ACR_NAME }} \
            --repository ${{ env.DOCKER_IMAGE_NAME }} \
            --query "[?@=='${{ needs.build-app.outputs.content_tag }}'] | length(@)" -o tsv)
          echo "exists=$EXISTS" >> "$GITHUB_OUTPUT"

      - name: Build image (only if missing)
        if: steps.exist.outputs.exists != '1'
        run: |
          docker build -f ${{ env.DOCKERFILE_PATH }} \
            -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-app.outputs.content_tag }} \
            .

      - name: Push image (only if missing)
        if: steps.exist.outputs.exists != '1'
        run: |
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-app.outputs.content_tag }}

      - name: Point :latest at the content tag (no re-push)
        run: |
          set -euo pipefail
          DIGEST=$(az acr manifest list-metadata \
            -r ${{ secrets.ACR_NAME }} \
            -n ${{ env.DOCKER_IMAGE_NAME }} \
            --query "[?tags[?@=='${{ needs.build-app.outputs.content_tag }}']].digest | [0]" -o tsv)
          az acr import \
            --name ${{ secrets.ACR_NAME }} \
            --source ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}@${DIGEST} \
            --image ${{ env.DOCKER_IMAGE_NAME }}:latest \
            --force

  deploy-to-aca:
    environment: production
    name: Deploy to ACA
    needs: [push-image]
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
      - name: Determine if ACA needs redeploy
        id: diff
        run: |
          set -euo pipefail
          DESIRED="${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-app.outputs.content_tag }}"
          CURRENT=$(az containerapp show \
            --name "${{ secrets.PROJ_AZDM_ACA_NAME }}" \
            --resource-group "${{ secrets.RG_NAME }}" \
            --query "properties.template.containers[0].image" -o tsv || echo "")
          echo "Current: $CURRENT"
          echo "Desired: $DESIRED"
          if [ "$CURRENT" = "$DESIRED" ]; then
            echo "deploy=false" >> "$GITHUB_OUTPUT"
          else
            echo "deploy=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to Azure Container Apps
        if: steps.diff.outputs.deploy == 'true'
        uses: azure/container-apps-deploy-action@v2
        with:
          registryUrl: ${{ secrets.ACR_NAME }}.azurecr.io
          containerAppName: ${{ secrets.PROJ_AZDM_ACA_NAME }}
          resourceGroup: ${{ secrets.RG_NAME }}
          imageToDeploy: ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ needs.build-app.outputs.content_tag }}
          environmentVariables: >
            APPLICATIONINSIGHTS_CONNECTION_STRING=${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}
            ASPNETCORE_ENVIRONMENT=${{ secrets.ASPNETCORE_ENVIRONMENT }}
            AZURE_CLIENT_ID=${{ secrets.PROJ_AZDM_UAMI_CLIENT_ID }}
            CVS_CONFIGURATION_FROM_AZURE_URL=${{ secrets.PROJ_AZDM_CONFIG_URL }}
            
  build-job-rwt:
    name: Build job (RWT)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ${{ env.PATH_TO_GLOBAL_JSON }}

      - name: Restore
        run: dotnet restore ${{ env.PATH_TO_CSPROJ_JOBS_RWT }}

      - name: Build
        run: dotnet build ${{ env.PATH_TO_CSPROJ_JOBS_RWT }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

      - name: Publish
        run: dotnet publish ${{ env.PATH_TO_CSPROJ_JOBS_RWT }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-build -o ./publish

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: job-rwt-publish
          path: ./publish
          
  push-image-job-rwt:
    environment: production
    name: Push image to ACR (RWT)
    needs: [ build-job-rwt ]
    runs-on: ubuntu-latest

    outputs:
      sha_tag: ${{ steps.vars.outputs.sha_tag }}

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: job-rwt-publish
          path: ./publish

      - name: Set image tags
        id: vars
        run: |
          echo "sha_tag=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build -f ${{ env.DOCKERFILE_PATH_JOB_RWT }} \
            -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME_JOB_RWT }}:latest \
            -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME_JOB_RWT }}:${{ steps.vars.outputs.sha_tag }} .

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Push image to ACR
        run: |
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME_JOB_RWT }}:latest
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME_JOB_RWT }}:${{ steps.vars.outputs.sha_tag }}
          
  deploy-to-aca-job-rwt:
    environment: production
    name: Deploy to Container Job (RWT)
    needs: [ push-image-job-rwt ]
      
    # Using Windows runner + PowerShell because ACA Job env var updates via Azure CLI are unreliable on Linux/Bash runners.
    # Verified 2025-08-08 after Linux/Bash path dropped env var values silently.
    runs-on: windows-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login with OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure containerapp extension is current
        shell: pwsh
        run: |
          az extension add --name containerapp --yes
          az extension update --name containerapp
          az version
          
      - name: Update ACA Job (PowerShell quoting)
        shell: pwsh
        run: |
          $jobName = "${{ secrets.PROJ_AZDM_JOB_RWT_NAME }}"
          $rg = "${{ secrets.RG_NAME }}"
          $image = "${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME_JOB_RWT }}:${{ needs.push-image-job-rwt.outputs.sha_tag }}"

          $appInsights = "${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}"
          $clientId = "${{ secrets.PROJ_AZDM_JOB_RWT_UAMI_CLIENT_ID }}"
          $configUrl = "${{ secrets.PROJ_AZDM_CONFIG_URL }}"
          $envName = "${{ secrets.DOTNET_ENVIRONMENT }}"

          az containerapp job update `
            --name $jobName `
            --resource-group $rg `
            --image $image `
            --set-env-vars `
              APPLICATIONINSIGHTS_CONNECTION_STRING="$appInsights" `
              AZURE_CLIENT_ID="$clientId" `
              CVS_CONFIGURATION_FROM_AZURE_URL="$configUrl" `
              DOTNET_ENVIRONMENT="$envName"